---
import { uniqueId } from "./uniqueid";
import Field from "./Field.astro";

export type Props = {
  name: string;
  defaultValue: number;
};

const cid = uniqueId("NumberField-");

const { name = "", defaultValue = 0 } = Astro.props;
---

<Field cid={cid} name={name} fieldType="NumberField">
  <input type="number" id={cid} name={name} value={defaultValue} />
</Field>

<style>
  input {
    background-color: var(--vscode-settings-textInputBackground);
    border: 1px solid var(--vscode-settings-textInputBorder);
    color: var(--vscode-foreground);
    font-family: var(--vscode-font-family);
    font-size: var(--vscode-font-size);
    font-weight: var(--vscode-font-weight);
    line-height: 18px;
    padding: 3px 4px;
  }
</style>

<script>
  function inputChange(ev: Event) {
    const field = (ev.target as HTMLInputElement).closest<HTMLDivElement>(
      '[data-astro-component="NumberField"]'
    )!;

    updateFieldTarget(field);
  }

  function updateFieldTarget(field: HTMLDivElement) {
    const root = field.closest<HTMLFieldSetElement>(
      '[data-astro-component="Controls"]'
    );
    const input = field.querySelector("input")!;

    if (root) {
      const target = root.dataset.target!;
      const targetEl = document.querySelector(target);

      if (targetEl) {
        // @ts-ignore
        targetEl[input.name] = input.value;
      }
    }
  }

  document
    .querySelectorAll<HTMLDivElement>('[data-astro-component="NumberField"]')
    .forEach((el) => {
      const cb = el.querySelector("input");
      cb?.addEventListener("input", inputChange);
      updateFieldTarget(el);
    });
</script>